<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='student.css') }}">
</head>
<body>

<header>
    <div class="logo">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="BSU Logo">
        <h1>BSU Safezone</h1>
    </div>
    <nav>
        <ul>
            <li><a href="{{ url_for('views.student_dashboard') }}">Home</a></li>
            <li><a href="{{ url_for('views.about') }}">About</a></li>
            <li><a href="{{ url_for('views.contact') }}">Contact</a></li>
            <li><a href="{{ url_for('views.logout') }}">Logout</a></li>
        </ul>
    </nav>
</header>

<div class="flash-messages">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
</div>

<div class="dashboard-container">

    <!-- LEFT CONTENT -->
    <div class="main-content">

        <h2>Welcome, {{ user.full_name }}</h2>

        <!-- SUBMIT REPORT -->
        <section class="submit-report">
            <h3>Submit a New Report</h3>
            <form method="POST" enctype="multipart/form-data">
                {{ form.hidden_tag() }}

                <div class="form-group">
                    {{ form.title.label }}
                    {{ form.title(class="form-input") }}
                </div>

                <div class="form-group">
                    {{ form.description.label }}
                    {{ form.description(class="form-input") }}
                </div>

                <div class="form-group">
                    {{ form.file_upload.label }}
                    {{ form.file_upload() }}
                    <small>Allowed: Images, Videos, Documents</small>
                </div>

                <div class="form-group">
                    {{ form.anonymous() }} {{ form.anonymous.label }}
                </div>

                <div class="form-group">
                    {{ form.submit(class="btn-submit") }}
                </div>
            </form>
        </section>

        <!-- REPORT HISTORY -->
        <section class="submitted-reports">
            <h3>Your Reports</h3>

            {% if reports %}
                {% for r in reports %}
                    <div class="report-entry {% if r.anonymous %}anonymous{% endif %}">
                        
                        <!-- TITLE -->
                        <h4>
                            {% if r.anonymous %}
                                Anonymous Report
                            {% else %}
                                {{ r.title }}
                            {% endif %}
                        </h4>

                        <!-- OWNER -->
                        <small>Submitted by: {% if r.anonymous %}You{% else %}{{ r.owner_name }}{% endif %}</small><br>

                        <!-- SUBMISSION TIME -->
                        {% if r.created_at %}
                            <small>Submitted: {{ r.created_at.strftime("%Y-%m-%d %H:%M:%S") }}</small>
                        {% endif %}

                        <!-- DESCRIPTION -->
                        <p>{{ r.description }}</p>

                        <!-- STATUS -->
                        <p>Status: <strong>{{ r.status }}</strong></p>

                        <!-- FILE ATTACHMENT -->
                        {% if r.file_url %}
                            {% set ext = r.file_url.rsplit('.', 1)[1].lower() %}
                            <div class="file-preview">
                                {% if ext in ['jpg','jpeg','png','gif'] %}
                                    <img src="{{ r.file_url }}" class="preview-img" alt="report attachment">
                                {% elif ext in ['mp4','mov','avi','mkv','webm'] %}
                                    <video controls class="preview-video">
                                        <source src="{{ r.file_url }}">
                                        Your browser does not support the video tag.
                                    </video>
                                {% else %}
                                    <p>File: <a href="{{ r.file_url }}" target="_blank">{{ r.file_url.split('/')[-1] }}</a></p>
                                {% endif %}
                            </div>
                        {% endif %}

                        <!-- ADMIN COMMENT -->
                        {% if r.admin_comment %}
                            <div class="admin-comment">
                                <strong>Admin Comment:</strong> {{ r.admin_comment }}
                                {% if r.admin_comment_created %}
                                    <br><small>Commented at: {{ r.admin_comment_created.strftime("%Y-%m-%d %H:%M:%S") }}</small>
                                {% endif %}
                            </div>
                        {% endif %}

                        <!-- STUDENT REPLIES -->
                        {% if r.student_replies %}
                            <div class="student-replies">
                                <strong>Replies:</strong>
                                {% for rep in r.student_replies %}
                                    <div class="reply-entry">
                                        <strong>{% if rep.anonymous %}You{% else %}{{ rep.user.full_name }}{% endif %}:</strong>
                                        {{ rep.reply }}
                                        {% if rep.created_at %}
                                            <br><small>Replied at: {{ rep.created_at.strftime("%Y-%m-%d %H:%M:%S") }}</small>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- REPLY FORM -->
                        <form method="POST" action="{{ url_for('views.reply_comment', report_id=r.id) }}">
                            {{ reply_form.hidden_tag() }}
                            <div class="form-group">
                                {{ reply_form.reply.label }}
                                {{ reply_form.reply(rows=2, class="form-input", placeholder="Write a reply...") }}
                            </div>
                            <div class="form-group">
                                {{ reply_form.submit(class="btn-submit") }}
                            </div>
                        </form>

                    </div>
                {% endfor %}
            {% else %}
                <p>No reports submitted yet.</p>
            {% endif %}
        </section>

    </div>

    <!-- RIGHT SIDEBAR -->
    <aside class="notifications-sidebar">
        <h3>Notifications</h3>
        {% if notifications %}
            <ul class="notif-list">
                {% for note in notifications %}
                    <li class="notif-item">
                        <p>{{ note.message }}</p>
                        <small>
                            From: <strong>{{ note.sender.full_name if note.sender else "BSU Safezone" }}</strong><br>
                            {{ note.created_at.strftime("%Y-%m-%d %H:%M:%S") }}
                        </small>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No notifications available.</p>
        {% endif %}
    </aside>

</div>

</body>
</html>